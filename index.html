<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—É—Ä–Ω–∏—Ä–Ω—ã–π Pong (–ò–≥—Ä–æ–∫ vs CPU)</title>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif, Arial, sans-serif;
            background-color: #0d1117; 
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px;
            background-color: #161b22;
            padding: 20px;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #gameCanvas {
            background-color: #010409;
            border: 2px solid #58a6ff;
            border-radius: 0.5rem;
            cursor: none;
            touch-action: none;
            max-width: 100%;
            margin-bottom: 1rem;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
        .ui-panel {
            width: 100%;
            padding: 1rem;
            background-color: #1f2937;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .flex-container {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap; /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }

        .flex-container > div {
            flex: 1 1 45%; /* –≠–ª–µ–º–µ–Ω—Ç—ã –∑–∞–Ω–∏–º–∞—é—Ç –ø–æ—á—Ç–∏ –ø–æ–ª–æ–≤–∏–Ω—É —à–∏—Ä–∏–Ω—ã */
            min-width: 250px;
        }

        .select-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: #9ca3af;
        }

        select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #374151;
            color: #ffffff;
            border: 1px solid #4b5563;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ */
        .btn {
            padding: 10px 30px;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 4px #0d47a1;
            transform: translateY(0);
            cursor: pointer;
            background-color: #58a6ff;
            color: #0d1117;
            margin-top: 1rem;
            width: 100%;
        }

        .btn:hover {
            background-color: #79c0ff;
            box-shadow: 0 2px #0d47a1;
            transform: translateY(2px);
        }

        .score-display {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #facc15;
            text-align: center;
            width: 100%;
        }
        
        .tournament-bracket {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .match-box {
            background-color: #374151;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            line-height: 1.25;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .match-box.active-match {
            border: 2px solid #ff7b72;
            box-shadow: 0 0 10px rgba(255, 123, 114, 0.7);
        }
        
        .match-title {
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        @media (max-width: 600px) {
            .flex-container > div {
                flex: 1 1 100%;
                min-width: unset;
            }
            .tournament-bracket {
                 grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1 style="font-size: 1.875rem; color: #60a5fa; font-weight: 700;">–ö—É–±–æ–∫ –ù–∞—Ü–∏–π Pong</h1>
    
    <div id="setup-panel" class="ui-panel">
        <div class="flex-container">
            <div>
                <label for="player-country" class="select-label">–í–∞—à–∞ –°—Ç—Ä–∞–Ω–∞ (P1)</label>
                <select id="player-country"></select>
            </div>
            <div>
                <label for="difficulty-level" class="select-label">–£—Ä–æ–≤–µ–Ω—å –°–ª–æ–∂–Ω–æ—Å—Ç–∏ CPU</label>
                <select id="difficulty-level">
                    <option value="beginner">–ù–æ–≤–∏—á–æ–∫</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="champion">–ß–µ–º–ø–∏–æ–Ω</option>
                </select>
            </div>
        </div>
        <button id="startTournamentButton" class="btn">–ù–∞—á–∞—Ç—å –¢—É—Ä–Ω–∏—Ä (8 –ö–æ–º–∞–Ω–¥)</button>
    </div>
    
    <div id="tournament-panel" class="ui-panel hidden">
        <div class="match-title">–¢—É—Ä–Ω–∏—Ä–Ω–∞—è –°–µ—Ç–∫–∞</div>
        <div class="tournament-bracket" id="bracket">
            <!-- –°–µ—Ç–∫–∞ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <div id="game-info" class="score-display">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –¢—É—Ä–Ω–∏—Ä".</div>

    <canvas id="gameCanvas" width="800" height="400" class="hidden"></canvas>
    
</div>

<script>
    // --- –î–ê–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
    
    const COUNTRIES = [
        { code: 'RUS', name: '–†–æ—Å—Å–∏—è', flag: 'üá∑üá∫' },
        { code: 'USA', name: '–°–®–ê', flag: 'üá∫üá∏' },
        { code: 'DEU', name: '–ì–µ—Ä–º–∞–Ω–∏—è', flag: 'üá©üá™' },
        { code: 'BRA', name: '–ë—Ä–∞–∑–∏–ª–∏—è', flag: 'üáßüá∑' },
        { code: 'JPN', name: '–Ø–ø–æ–Ω–∏—è', flag: 'üáØüáµ' },
        { code: 'FRA', name: '–§—Ä–∞–Ω—Ü–∏—è', flag: 'üá´üá∑' },
        { code: 'CAN', name: '–ö–∞–Ω–∞–¥–∞', flag: 'üá®üá¶' },
        { code: 'ITA', name: '–ò—Ç–∞–ª–∏—è', flag: 'üáÆüáπ' },
        { code: 'GBR', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', flag: 'üá¨üáß' },
        { code: 'AUS', name: '–ê–≤—Å—Ç—Ä–∞–ª–∏—è', flag: 'üá¶üá∫' },
        { code: 'KOR', name: '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è', flag: 'üá∞üá∑' },
        { code: 'MEX', name: '–ú–µ–∫—Å–∏–∫–∞', flag: 'üá≤üáΩ' },
    ];
    
    const DIFFICULTY_SETTINGS = {
        beginner: { speed: 0.15, errorChance: 0.4, paddleSpeed: 4 }, // –ù–∏–∑–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏, –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫
        medium: { speed: 0.25, errorChance: 0.15, paddleSpeed: 5 }, // –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å, —Å—Ä–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
        champion: { speed: 0.35, errorChance: 0.03, paddleSpeed: 6 } // –í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
    };

    // --- –ù–ê–°–¢–†–û–ô–ö–ê –ò–ì–†–´ ---
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const infoDisplay = document.getElementById('game-info');
    const setupPanel = document.getElementById('setup-panel');
    const tournamentPanel = document.getElementById('tournament-panel');
    const startTournamentButton = document.getElementById('startTournamentButton');
    const playerCountrySelect = document.getElementById('player-country');
    const difficultyLevelSelect = document.getElementById('difficulty-level');

    const game = {
        width: 800, height: 400,
        paddle: { width: 10, height: 80, speed: 6 },
        ball: { size: 10, speedX: 5, speedY: 5 },
        WIN_SCORE: 5 // –£–º–µ–Ω—å—à–µ–Ω –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
    };

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
    let paddleLeft = { x: 0, y: game.height / 2 - game.paddle.height / 2, score: 0 };
    let paddleRight = { x: game.width - game.paddle.width, y: game.height / 2 - game.paddle.height / 2, score: 0 };
    let ball = { x: game.width / 2, y: game.height / 2, dx: game.ball.speedX, dy: game.ball.speedY };
    let isGameRunning = false;
    let inputY = paddleLeft.y; 
    let currentDifficulty = DIFFICULTY_SETTINGS.medium;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
    let playerTeam = null;
    let cpuTeam = null;
    let tournamentBracket = [];
    let currentMatchIndex = 0;
    let roundNames = ["–ß–µ—Ç–≤–µ—Ä—Ç—å—Ñ–∏–Ω–∞–ª", "–ü–æ–ª—É—Ñ–∏–Ω–∞–ª", "–§–∏–Ω–∞–ª"];

    // --- –õ–û–ì–ò–ö–ê –¢–£–†–ù–ò–†–ê ---

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ (–ê–ª–≥–æ—Ä–∏—Ç–º –§–∏—à–µ—Ä–∞-–ô–µ—Ç—Å–∞)
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏ (8 –∫–æ–º–∞–Ω–¥)
    function generateTournamentBracket(playerCountryCode) {
        let availableCountries = COUNTRIES.filter(c => c.code !== playerCountryCode);
        shuffle(availableCountries);

        // –ë–µ—Ä–µ–º 7 —Å–ª—É—á–∞–π–Ω—ã—Ö CPU –∫–æ–º–∞–Ω–¥
        const tournamentTeams = availableCountries.slice(0, 7);
        const playerTeamData = COUNTRIES.find(c => c.code === playerCountryCode);
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –ø–µ—Ä–≤–æ–π –≤–æ—Å—å–º–µ—Ä–∫–µ
        const playerIndex = Math.floor(Math.random() * 8);
        tournamentTeams.splice(playerIndex, 0, playerTeamData);

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: 8 –∫–æ–º–∞–Ω–¥ -> 4 –º–∞—Ç—á–∞ QF -> 2 –º–∞—Ç—á–∞ SF -> 1 –º–∞—Ç—á F
        let bracket = [];
        
        // 1. –ß–µ—Ç–≤–µ—Ä—Ç—å—Ñ–∏–Ω–∞–ª (QF)
        for (let i = 0; i < 4; i++) {
            bracket.push({
                id: `QF${i + 1}`,
                round: 0,
                team1: tournamentTeams[i * 2],
                team2: tournamentTeams[i * 2 + 1],
                winner: null,
                isPlayerMatch: (tournamentTeams[i * 2].code === playerCountryCode || tournamentTeams[i * 2 + 1].code === playerCountryCode)
            });
        }
        
        // 2. –ü–æ–ª—É—Ñ–∏–Ω–∞–ª (SF) - Placeholder
        bracket.push({ id: 'SF1', round: 1, team1: null, team2: null, winner: null, isPlayerMatch: false });
        bracket.push({ id: 'SF2', round: 1, team1: null, team2: null, winner: null, isPlayerMatch: false });

        // 3. –§–∏–Ω–∞–ª (F) - Placeholder
        bracket.push({ id: 'F1', round: 2, team1: null, team2: null, winner: null, isPlayerMatch: false });
        
        return bracket;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
    function renderBracket() {
        const bracketDiv = document.getElementById('bracket');
        bracketDiv.innerHTML = '';
        bracketDiv.style.gridTemplateColumns = roundNames.map(() => '1fr').join(' ');

        roundNames.forEach((roundName, roundIndex) => {
            const roundMatches = tournamentBracket.filter(m => m.round === roundIndex);
            
            const roundColumn = document.createElement('div');
            roundColumn.innerHTML = `<div class="match-title">${roundName}</div>`;
            roundColumn.style.display = 'flex';
            roundColumn.style.flexDirection = 'column';
            roundColumn.style.gap = '1rem';
            
            roundMatches.forEach(match => {
                const isCurrent = (tournamentBracket.indexOf(match) === currentMatchIndex) && !match.winner;
                
                const box = document.createElement('div');
                box.className = `match-box ${isCurrent ? 'active-match' : ''}`;
                box.dataset.matchId = match.id;
                
                const team1Name = match.team1 ? `${match.team1.flag} ${match.team1.code}` : '???';
                const team2Name = match.team2 ? `${match.team2.flag} ${match.team2.code}` : '???';
                
                if (match.winner) {
                    box.innerHTML = `
                        <div style="font-weight: 700; color: #48bb78;">${match.winner.flag} ${match.winner.code} - –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
                    `;
                } else if (match.team1 && match.team2) {
                    box.innerHTML = `
                        <div>${team1Name}</div>
                        <div style="border-top: 1px dashed #4b5563; margin: 0.25rem 0;"></div>
                        <div>${team2Name}</div>
                    `;
                    if (isCurrent && match.isPlayerMatch) {
                        box.style.cursor = 'pointer';
                        box.onclick = () => startPlayerMatch(match);
                        box.title = "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å!";
                    }
                } else {
                    box.innerHTML = `<div>–û–∂–∏–¥–∞–Ω–∏–µ...</div>`;
                }

                roundColumn.appendChild(box);
            });
            bracketDiv.appendChild(roundColumn);
        });
    }

    // –ò–º–∏—Ç–∞—Ü–∏—è –º–∞—Ç—á–∞ CPU vs CPU
    function simulateCpuMatch(match) {
        const winnerIndex = Math.random() < 0.5 ? 1 : 2; // –°–ª—É—á–∞–π–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
        return winnerIndex === 1 ? match.team1 : match.team2;
    }
    
    // –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞
    function advanceTournament() {
        if (currentMatchIndex >= tournamentBracket.length) {
            infoDisplay.textContent = `${tournamentBracket[tournamentBracket.length - 1].winner.flag} ${tournamentBracket[tournamentBracket.length - 1].winner.code} - –ß–ï–ú–ü–ò–û–ù –ö–£–ë–ö–ê –ù–ê–¶–ò–ô PONG!`;
            isGameRunning = false;
            setupPanel.classList.remove('hidden');
            canvas.classList.add('hidden');
            return;
        }

        let match = tournamentBracket[currentMatchIndex];
        
        // –ï—Å–ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω (–º–∞—Ç—á —Å—ã–≥—Ä–∞–Ω), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if (match.winner) {
            currentMatchIndex++;
            advanceTournament();
            return;
        }
        
        if (!match.isPlayerMatch) {
            // –ò–º–∏—Ç–∞—Ü–∏—è –º–∞—Ç—á–∞ CPU
            match.winner = simulateCpuMatch(match);
            currentMatchIndex++;
            advanceTournament(); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
        } else {
            // –ú–∞—Ç—á –∏–≥—Ä–æ–∫–∞: —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
            infoDisplay.textContent = `–í–∞—à —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ç—á: ${match.team1.flag} ${match.team1.code} vs ${match.team2.flag} ${match.team2.code}. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–π –º–∞—Ç—á –≤ —Å–µ—Ç–∫–µ.`;
            renderBracket();
            canvas.classList.add('hidden');
            setupPanel.classList.add('hidden');
            tournamentPanel.classList.remove('hidden');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞—Ç—á–∞ (–∫–∞–∫ CPU, —Ç–∞–∫ –∏ –ò–≥—Ä–æ–∫–∞)
    function finalizeMatch(winnerTeam) {
        const match = tournamentBracket[currentMatchIndex];
        match.winner = winnerTeam;
        
        // –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
        const nextRoundMatchIndex = Math.floor(currentMatchIndex / 2) + 4; // QF -> SF
        
        if (match.round === 0) { // –ò–∑ QF –≤ SF
            const nextMatch = tournamentBracket[nextRoundMatchIndex];
            if (currentMatchIndex % 2 === 0) { // –ü–µ—Ä–≤—ã–π –º–∞—Ç—á –ø–∞—Ä—ã
                nextMatch.team1 = winnerTeam;
            } else { // –í—Ç–æ—Ä–æ–π –º–∞—Ç—á –ø–∞—Ä—ã
                nextMatch.team2 = winnerTeam;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ç—á –º–∞—Ç—á–µ–º –∏–≥—Ä–æ–∫–∞
            nextMatch.isPlayerMatch = nextMatch.isPlayerMatch || (winnerTeam.code === playerTeam.code);
            
        } else if (match.round === 1) { // –ò–∑ SF –≤ F
            const finalMatch = tournamentBracket[6];
            if (currentMatchIndex === 4) {
                finalMatch.team1 = winnerTeam;
            } else {
                finalMatch.team2 = winnerTeam;
            }
            finalMatch.isPlayerMatch = finalMatch.isPlayerMatch || (winnerTeam.code === playerTeam.code);
        }

        currentMatchIndex++;
        
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç—É—Ä–Ω–∏—Ä
        advanceTournament();
    }
    
    // --- –ù–ê–°–¢–†–û–ô–ö–ê –ò –ó–ê–ü–£–°–ö –ò–ì–†–´ ---
    
    // –ó–∞–ø—É—Å–∫ —Ç—É—Ä–Ω–∏—Ä–∞
    startTournamentButton.addEventListener('click', () => {
        const playerCode = playerCountrySelect.value;
        const difficulty = difficultyLevelSelect.value;

        playerTeam = COUNTRIES.find(c => c.code === playerCode);
        currentDifficulty = DIFFICULTY_SETTINGS[difficulty];
        
        tournamentBracket = generateTournamentBracket(playerCode);
        currentMatchIndex = 0;
        
        setupPanel.classList.add('hidden');
        tournamentPanel.classList.remove('hidden');
        
        advanceTournament(); // –ù–∞—á–∏–Ω–∞–µ–º —Ç—É—Ä–Ω–∏—Ä, —Å–∏–º—É–ª–∏—Ä—É—è CPU –º–∞—Ç—á–∏ –¥–æ –º–∞—Ç—á–∞ –∏–≥—Ä–æ–∫–∞
    });
    
    // –ó–∞–ø—É—Å–∫ –º–∞—Ç—á–∞ –∏–≥—Ä–æ–∫–∞
    function startPlayerMatch(match) {
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥
        paddleLeft.country = match.team1;
        paddleRight.country = match.team2;
        
        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —Å–ª–µ–≤–∞
        if (paddleLeft.country.code === playerTeam.code) {
            cpuTeam = paddleRight.country;
        } 
        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —Å–ø—Ä–∞–≤–∞ (–ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –≤—Å–µ–≥–¥–∞ –±—ã–ª —Å–ª–µ–≤–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
        else {
            cpuTeam = paddleLeft.country;
            // –ü–æ–º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞, —á—Ç–æ–±—ã P1 –≤—Å–µ–≥–¥–∞ –±—ã–ª —Å–ª–µ–≤–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è
            let temp = paddleLeft.country;
            paddleLeft.country = paddleRight.country;
            paddleRight.country = temp;
        }

        infoDisplay.textContent = `–ò–≥—Ä–∞: ${paddleLeft.country.flag} ${paddleLeft.country.code} vs ${paddleRight.country.flag} ${paddleRight.country.code}. –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${difficultyLevelSelect.value}`;
        
        tournamentPanel.classList.add('hidden');
        canvas.classList.remove('hidden');
        
        // –°–±—Ä–æ—Å –∏ –∑–∞–ø—É—Å–∫
        paddleLeft.score = 0;
        paddleRight.score = 0;
        paddleLeft.y = game.height / 2 - game.paddle.height / 2;
        paddleRight.y = game.height / 2 - game.paddle.height / 2;
        resetBall(1);
        isGameRunning = true;
        
        requestAnimationFrame(gameLoop);
    }
    
    // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê PONG ---

    function resetBall(direction = 1) {
        ball.x = game.width / 2;
        ball.y = game.height / 2;
        ball.dx = (direction > 0 ? game.ball.speedX : -game.ball.speedX);
        ball.dy = (Math.random() * 2 - 1) * game.ball.speedY; 
    }
    
    function draw() {
        // –û—á–∏—Å—Ç–∫–∞
        ctx.fillStyle = '#010409'; 
        ctx.fillRect(0, 0, game.width, game.height);

        // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
        ctx.strokeStyle = '#58a6ff';
        ctx.setLineDash([10, 5]);
        ctx.beginPath();
        ctx.moveTo(game.width / 2, 0);
        ctx.lineTo(game.width / 2, game.height);
        ctx.stroke();
        ctx.setLineDash([]);

        // –†–∞–∫–µ—Ç–∫–∏
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(paddleLeft.x, paddleLeft.y, game.paddle.width, game.paddle.height);
        
        ctx.fillStyle = '#9ca3af'; 
        ctx.fillRect(paddleRight.x, paddleRight.y, game.paddle.width, game.paddle.height);

        // –ú—è—á
        ctx.fillStyle = '#ff7b72';
        ctx.fillRect(ball.x - game.ball.size / 2, ball.y - game.ball.size / 2, game.ball.size, game.ball.size);
        
        // –°—á–µ—Ç –∏ –°—Ç—Ä–∞–Ω—ã
        ctx.font = '40px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(paddleLeft.score, game.width / 4, 40);
        ctx.fillText(paddleRight.score, game.width * 3 / 4, 40);
        
        ctx.font = '20px Inter';
        ctx.fillText(`${paddleLeft.country.flag} ${paddleLeft.country.code}`, game.width / 4, 70);
        ctx.fillText(`${paddleRight.country.flag} ${paddleRight.country.code}`, game.width * 3 / 4, 70);
    }

    // –õ–æ–≥–∏–∫–∞ CPU, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    function updateCpu() {
        const settings = currentDifficulty;
        const cpuCenter = paddleRight.y + game.paddle.height / 2;
        
        // 1. –®–∞–Ω—Å –æ—à–∏–±–∫–∏ (CPU –∏–Ω–æ–≥–¥–∞ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è)
        if (Math.random() < settings.errorChance) {
            return;
        }

        // 2. CPU —Ä–µ–∞–≥–∏—Ä—É–µ—Ç, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º—è—á –ª–µ—Ç–∏—Ç –≤ –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω—É
        if (ball.dx > 0) { 
            const diff = ball.y - cpuCenter;
            const moveSpeed = settings.paddleSpeed;
            
            // 3. –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ (–Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è)
            paddleRight.y += diff * settings.speed; 
        }

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CPU
        paddleRight.y = Math.max(0, Math.min(paddleRight.y, game.height - game.paddle.height));
    }


    function update() {
        // --- –î–≤–∏–∂–µ–Ω–∏–µ P1 (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à—å—é/—Å–µ–Ω—Å–æ—Ä–æ–º) ---
        // –î–≤–∏–∂–µ–Ω–∏–µ —Ä–∞–∫–µ—Ç–∫–∏ P1 –ø–ª–∞–≤–Ω–æ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –ø–æ–∑–∏—Ü–∏–µ–π –∫—É—Ä—Å–æ—Ä–∞/–∫–∞—Å–∞–Ω–∏—è
        const targetY = inputY - game.paddle.height / 2;
        paddleLeft.y += (targetY - paddleLeft.y) * 0.15; 
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ P1
        paddleLeft.y = Math.max(0, Math.min(paddleLeft.y, game.height - game.paddle.height));

        // --- –î–≤–∏–∂–µ–Ω–∏–µ CPU ---
        updateCpu();

        // --- –î–≤–∏–∂–µ–Ω–∏–µ –ú—è—á–∞ ---
        ball.x += ball.dx;
        ball.y += ball.dy;

        // –û—Ç—Å–∫–æ–∫ –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ/–Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è
        if (ball.y <= 0 || ball.y >= game.height) {
            ball.dy *= -1;
        }

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å —Ä–∞–∫–µ—Ç–∫–∞–º–∏ ---
        
        // –õ–µ–≤–∞—è —Ä–∞–∫–µ—Ç–∫–∞ (P1)
        if (ball.x <= game.paddle.width && ball.y > paddleLeft.y && ball.y < paddleLeft.y + game.paddle.height) {
            ball.dx *= -1;
            ball.dx = Math.min(Math.abs(ball.dx) * 1.05, 10);
            ball.dy = (ball.y - (paddleLeft.y + game.paddle.height / 2)) * 0.3;
        }

        // –ü—Ä–∞–≤–∞—è —Ä–∞–∫–µ—Ç–∫–∞ (CPU)
        if (ball.x >= game.width - game.paddle.width - game.ball.size && ball.y > paddleRight.y && ball.y < paddleRight.y + game.paddle.height) {
            ball.dx *= -1;
            ball.dx = Math.max(-Math.abs(ball.dx) * 1.05, -10);
            ball.dy = (ball.y - (paddleRight.y + game.paddle.height / 2)) * 0.3;
        }

        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ì–æ–ª–æ–≤ ---
        if (ball.x < 0) {
            paddleRight.score++;
            infoDisplay.textContent = `–ì–æ–ª! ${paddleRight.country.code} –∑–∞–±–∏–≤–∞–µ—Ç. –°—á–µ—Ç: ${paddleLeft.score} - ${paddleRight.score}`;
            resetBall(-1); 
            checkWin();
        } else if (ball.x > game.width) {
            paddleLeft.score++;
            infoDisplay.textContent = `–ì–æ–ª! ${paddleLeft.country.code} –∑–∞–±–∏–≤–∞–µ—Ç. –°—á–µ—Ç: ${paddleLeft.score} - ${paddleRight.score}`;
            resetBall(1); 
            checkWin();
        }
    }

    function checkWin() {
        if (paddleLeft.score >= game.WIN_SCORE || paddleRight.score >= game.WIN_SCORE) {
            isGameRunning = false;
            
            const winnerTeam = paddleLeft.score > paddleRight.score ? paddleLeft.country : paddleRight.country;
            const loserTeam = paddleLeft.score < paddleRight.score ? paddleLeft.country : paddleRight.country;
            
            infoDisplay.textContent = `${winnerTeam.flag} ${winnerTeam.code} –ø–æ–±–µ–∂–¥–∞–µ—Ç ${loserTeam.flag} ${loserTeam.code} —Å–æ —Å—á–µ—Ç–æ–º ${paddleLeft.score} - ${paddleRight.score}!`;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –∏–∑ —Ç–µ–∫—É—â–∏—Ö –∫–æ–º–∞–Ω–¥ –±—ã–ª –ò–≥—Ä–æ–∫–æ–º (PlayerTeam)
            let actualWinner = null;
            if (winnerTeam.code === playerTeam.code) {
                actualWinner = playerTeam;
            } else {
                // –ü–æ–±–µ–¥–∏–ª CPU –≤ –º–∞—Ç—á–µ –∏–≥—Ä–æ–∫–∞. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∏–≥—Ä–æ–∫ –≤—ã–±—ã–ª.
                actualWinner = loserTeam.code === playerTeam.code ? loserTeam : winnerTeam; 
            }
            
            setTimeout(() => {
                finalizeMatch(winnerTeam);
            }, 3000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –º–∞—Ç—á—É
        }
    }

    function gameLoop() {
        if (!isGameRunning) return;
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
    
    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–í–û–î–ê (–ú—ã—à—å/–°–µ–Ω—Å–æ—Ä) ---
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isGameRunning) return;
        const rect = canvas.getBoundingClientRect();
        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        inputY = (e.clientY - rect.top) * (canvas.height / rect.height);
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isGameRunning) return;
        const rect = canvas.getBoundingClientRect();
        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        inputY = (e.touches[0].clientY - rect.top) * (canvas.height / rect.height);
    });
    
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    
    function initialize() {
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω
        const fragment = document.createDocumentFragment();
        COUNTRIES.forEach(country => {
            const option = document.createElement('option');
            option.value = country.code;
            option.textContent = `${country.flag} ${country.name}`;
            fragment.appendChild(option);
        });
        playerCountrySelect.appendChild(fragment);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞ –∏ –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫
        canvas.width = game.width;
        canvas.height = game.height;
        
        // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–∞–Ω—É –¥–ª—è –∏–≥—Ä–æ–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        playerCountrySelect.value = COUNTRIES[Math.floor(Math.random() * COUNTRIES.length)].code;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ—Ç–∫–∏ —Å—Ç—Ä–∞–Ω –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
        paddleLeft.country = COUNTRIES.find(c => c.code === playerCountrySelect.value);
        paddleRight.country = COUNTRIES.find(c => c.code !== playerCountrySelect.value)[0] || COUNTRIES[0];
        
        draw();
    }
    
    initialize();
    
</script>

</body>
</html>